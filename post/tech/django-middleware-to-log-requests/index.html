<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Django Middleware: log requests and responses | wilspi</title>

<meta name="keywords" content="django, middleware, python" />
<meta name="description" content="From Django&rsquo;s context:
 Middleware is a framework of hooks into Django’s request/response processing.
It’s a light, low-level “plugin” system for globally altering Django’s input or output.
 Middleware is like a layer which processes every request and response. Instead of logging requests and responses in resp. views, its better to do at middleware layer which will log every incoming request. Why better?
 it will log unhandled requests/views one time job, no need to configure for every request/view  Here, we are using Django&rsquo;s middleware semantics to construct a middleware which will log all requests and corresponding responses.">
<meta name="author" content="wilspi">
<link rel="canonical" href="https://wilspi.com/post/tech/django-middleware-to-log-requests/" />
<link href="/assets/css/stylesheet.min.f580a29692e0c7eb72865ec0bd4ee916bef2dc7e85f4fbfdf6a609b3a0f4f6a1.css" integrity="sha256-9YCilpLgx&#43;tyhl7AvU7pFr7y3H6F9Pv99qYJs6D09qE=" rel="preload stylesheet"
    as="style">

<link rel="icon" href="https://wilspi.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://wilspi.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://wilspi.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://wilspi.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://wilspi.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<meta name="generator" content="Hugo 0.79.0" />



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-51915090-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta property="og:title" content="Django Middleware: log requests and responses" />
<meta property="og:description" content="From Django&rsquo;s context:
 Middleware is a framework of hooks into Django’s request/response processing.
It’s a light, low-level “plugin” system for globally altering Django’s input or output.
 Middleware is like a layer which processes every request and response. Instead of logging requests and responses in resp. views, its better to do at middleware layer which will log every incoming request. Why better?
 it will log unhandled requests/views one time job, no need to configure for every request/view  Here, we are using Django&rsquo;s middleware semantics to construct a middleware which will log all requests and corresponding responses." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wilspi.com/post/tech/django-middleware-to-log-requests/" />
<meta property="og:image" content="https://wilspi.com/images/cover.jpg"/>
<meta property="article:published_time" content="2020-07-29T22:00:00+05:30" />
<meta property="article:modified_time" content="2020-07-29T22:00:00+05:30" /><meta property="og:site_name" content="नमस्ते" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://wilspi.com/images/cover.jpg"/>

<meta name="twitter:title" content="Django Middleware: log requests and responses"/>
<meta name="twitter:description" content="From Django&rsquo;s context:
 Middleware is a framework of hooks into Django’s request/response processing.
It’s a light, low-level “plugin” system for globally altering Django’s input or output.
 Middleware is like a layer which processes every request and response. Instead of logging requests and responses in resp. views, its better to do at middleware layer which will log every incoming request. Why better?
 it will log unhandled requests/views one time job, no need to configure for every request/view  Here, we are using Django&rsquo;s middleware semantics to construct a middleware which will log all requests and corresponding responses."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://wilspi.com/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Django Middleware: log requests and responses",
      "item": "https://wilspi.com/post/tech/django-middleware-to-log-requests/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Django Middleware: log requests and responses",
  "name": "Django Middleware: log requests and responses",
  "description": "From Django\u0026amp;rsquo;s context:\n Middleware is a framework of hooks into Django’s request/response processing.\nIt’s a light, low-level “plugin” system for globally altering Django’s …",
  "keywords": [
    "django", "middleware", "python"
  ],
  "articleBody": "From Django’s context:\n Middleware is a framework of hooks into Django’s request/response processing.\nIt’s a light, low-level “plugin” system for globally altering Django’s input or output.\n Middleware is like a layer which processes every request and response. Instead of logging requests and responses in resp. views, its better to do at middleware layer which will log every incoming request. Why better?\n it will log unhandled requests/views one time job, no need to configure for every request/view  Here, we are using Django’s middleware semantics to construct a middleware which will log all requests and corresponding responses.\n  Create a middleware file We will create a RequestLogMiddleware class in /middleware/request_log.py in your  folder, like:\n \"\"\" Middleware to log `*/api/*` requests and responses. \"\"\" import socket import time import json import logging request_logger = logging.getLogger(__name__) class RequestLogMiddleware: \"\"\"Request Logging Middleware.\"\"\" def __init__(self, get_response): self.get_response = get_response def __call__(self, request): start_time = time.time() log_data = { \"remote_address\": request.META[\"REMOTE_ADDR\"], \"server_hostname\": socket.gethostname(), \"request_method\": request.method, \"request_path\": request.get_full_path(), } # Only logging \"*/api/*\" patterns if \"/api/\" in str(request.get_full_path()): req_body = json.loads(request.body.decode(\"utf-8\")) if request.body else {} log_data[\"request_body\"] = req_body response = self.get_response(request) if response and response[\"content-type\"] == \"application/json\": response_body = json.loads(response.content.decode(\"utf-8\")) log_data[\"response_body\"] = response_body log_data[\"run_time\"] = time.time() - start_time request_logger.info(msg=log_data) return response # Log unhandled exceptions as well def process_exception(self, request, exception): try: raise exception except Exception as e: request_logger.exception(\"Unhandled Exception: \" + str(e)) return exception Here we are logging only requests with /api/ in its path. All the processing is done in __call__ method.\nNote: Do add __init__.py in middleware folder.\n  Activate the middleware Activate the middleware by adding its path in MIDDLEWARE list in your Django’s application settings.py (here: last value):\nMIDDLEWARE = [ \"django.middleware.security.SecurityMiddleware\", \"django.contrib.sessions.middleware.SessionMiddleware\", \"django.middleware.common.CommonMiddleware\", \"django.contrib.auth.middleware.AuthenticationMiddleware\", \"django.contrib.messages.middleware.MessageMiddleware\", # Request Logger \".middleware.request_log.RequestLogMiddleware\", ] Replace  with your application name.\n  ",
  "wordCount" : "293",
  "inLanguage": "en",
  "datePublished": "2020-07-29T22:00:00+05:30",
  "dateModified": "2020-07-29T22:00:00+05:30",
  "author":{
    "@type": "Person",
    "name": "wilspi"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://wilspi.com/post/tech/django-middleware-to-log-requests/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "wilspi",
    "logo": {
      "@type": "ImageObject",
      "url": "https://wilspi.com/favicon.ico"
    }
  }
}
</script>





</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>
<noscript>
    <style type="text/css">
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://wilspi.com" accesskey="h" title="wilspi (Alt + H)">wilspi</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                
                
            </span>
        </div>
        <ul id="menu" onscroll="menu_on_scroll()">
            <li>
                <a href="https://wilspi.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://notes.wilspi.com" title="Notes">
                    <span>Notes</span>
                </a>
            </li></ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">

    <h1 class="post-title">
      Django Middleware: log requests and responses
    </h1>
    <div class="post-meta">

July 29, 2020&nbsp;·&nbsp;2 min&nbsp;·&nbsp;wilspi

</div>
  </header> 

  <div class="post-content">
<p>From <a href="https://www.djangoproject.com/">Django</a>&rsquo;s context:</p>
<blockquote>
<p>Middleware is a framework of hooks into Django’s request/response processing.<br>
It’s a light, low-level “plugin” system for globally altering Django’s input or output.</p>
</blockquote>
<p>Middleware is like a layer which processes every request and response. Instead of logging requests and responses in resp. <a href="https://docs.djangoproject.com/en/3.0/topics/http/views/">views</a>, its better to do at middleware layer which will log every incoming request.
Why better?</p>
<ul>
<li>it will log unhandled requests/views</li>
<li>one time job, no need to configure for every request/view</li>
</ul>
<p>Here, we are using Django&rsquo;s <a href="https://docs.djangoproject.com/en/3.0/topics/http/middleware/#writing-your-own-middleware">middleware semantics</a> to construct a middleware which will log all requests and corresponding responses.</p>
<ul>
<li>
<h4 id="create-a-middleware-file">Create a middleware file<a hidden class="anchor" aria-hidden="true" href="#create-a-middleware-file">#</a></h4>
<p>We will create a <code>RequestLogMiddleware</code> class in <code>/middleware/request_log.py</code> in your <code>&lt;application&gt;</code> folder, like:</p>
<pre><code>
&quot;&quot;&quot;
Middleware to log `*/api/*` requests and responses.
&quot;&quot;&quot;
import socket
import time
import json
import logging

request_logger = logging.getLogger(__name__)

class RequestLogMiddleware:
    &quot;&quot;&quot;Request Logging Middleware.&quot;&quot;&quot;

    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        start_time = time.time()
        log_data = {
            &quot;remote_address&quot;: request.META[&quot;REMOTE_ADDR&quot;],
            &quot;server_hostname&quot;: socket.gethostname(),
            &quot;request_method&quot;: request.method,
            &quot;request_path&quot;: request.get_full_path(),
        }

        # Only logging &quot;*/api/*&quot; patterns
        if &quot;/api/&quot; in str(request.get_full_path()):
            req_body = json.loads(request.body.decode(&quot;utf-8&quot;)) if request.body else {}
            log_data[&quot;request_body&quot;] = req_body

        response = self.get_response(request)

        if response and response[&quot;content-type&quot;] == &quot;application/json&quot;:
            response_body = json.loads(response.content.decode(&quot;utf-8&quot;))
            log_data[&quot;response_body&quot;] = response_body
        log_data[&quot;run_time&quot;] = time.time() - start_time

        request_logger.info(msg=log_data)

        return response

    # Log unhandled exceptions as well
    def process_exception(self, request, exception):
        try:
            raise exception
        except Exception as e:
            request_logger.exception(&quot;Unhandled Exception: &quot; + str(e))
        return exception
</code></pre><p>Here we are logging only requests with <code>/api/</code> in its path.
All the processing is done in <code>__call__</code> method.<br>
Note: Do add <code>__init__.py</code> in <code>middleware</code> folder.</p>
</li>
<li>
<h4 id="activate-the-middleware">Activate the middleware<a hidden class="anchor" aria-hidden="true" href="#activate-the-middleware">#</a></h4>
<p><a href="https://docs.djangoproject.com/en/3.0/topics/http/middleware/#activating-middleware">Activate the middleware</a> by adding its path in <code>MIDDLEWARE</code> list in your Django&rsquo;s application <code>settings.py</code> (here: last value):</p>
<pre><code>MIDDLEWARE = [
    &quot;django.middleware.security.SecurityMiddleware&quot;,
    &quot;django.contrib.sessions.middleware.SessionMiddleware&quot;,
    &quot;django.middleware.common.CommonMiddleware&quot;,
    &quot;django.contrib.auth.middleware.AuthenticationMiddleware&quot;,
    &quot;django.contrib.messages.middleware.MessageMiddleware&quot;,
    # Request Logger
    &quot;&lt;application&gt;.middleware.request_log.RequestLogMiddleware&quot;,
]
</code></pre><p>Replace <code>&lt;application&gt;</code> with your application name.</p>
</li>
</ul>

</div>
  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://wilspi.com/tags/django/">django</a></li>
      <li><a href="https://wilspi.com/tags/middleware/">middleware</a></li>
      <li><a href="https://wilspi.com/tags/python/">python</a></li>
    </ul>
  </footer>
</article>
    </main><footer class="footer">
    <span>&middot;</span>
    <span>&copy; 2021 <a href="https://wilspi.com">wilspi</a></span>
    <span>&middot;</span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)">
    <button class="top-link" id="top-link" type="button" accesskey="g">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z" />
        </svg>
    </button>
</a>



<script defer src="/assets/js/highlight.min.27cd435cc9ed6abb4b496581b151804f79f366c412620272bb94e2f5f598ebcc.js" integrity="sha256-J81DXMntartLSWWBsVGAT3nzZsQSYgJyu5Ti9fWY68w="
    onload="hljs.initHighlightingOnLoad();"></script>
<script>
    window.onload = function () {
        if (localStorage.getItem("menu-scroll-position")) {
            document.getElementById('menu').scrollLeft = localStorage.getItem("menu-scroll-position");
        }
    }
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

    function menu_on_scroll() {
        localStorage.setItem("menu-scroll-position", document.getElementById('menu').scrollLeft);
    }

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>

</body>

</html>
