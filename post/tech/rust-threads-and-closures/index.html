<!DOCTYPE html>
<html lang="en" data-theme="light"><head>
    <title> Rust: Closures and Threads | wilspi </title>
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.74.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="">
    
    <link rel="stylesheet" href="https://wilspi.com/css/style.min.67cd718c0a3c8009c771494d381fb7128246a454bd0518fed97cb65d257db948.css" integrity="sha256-Z81xjAo8gAnHcUlNOB&#43;3EoJGpFS9BRj&#43;2Xy2XSV9uUg=" crossorigin="anonymous" type="text/css"><link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    
    <link rel="shortcut icon" href="https://wilspi.com/favicons/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://wilspi.com/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://wilspi.com/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://wilspi.com/favicons/favicon-16x16.png">
    <link rel="canonical" href="https://wilspi.com/post/tech/rust-threads-and-closures/">
    
    
    <script type="text/javascript" src="https://wilspi.com/js/anatole-header.min.c275265a259296f3dd50e8236a77fcbcadb1dbb9597d3045c675dcc2c7c58a93.js" integrity="sha256-wnUmWiWSlvPdUOgjanf8vK2x27lZfTBFxnXcwsfFipM=" crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://wilspi.com/images/cover.jpg"/>

<meta name="twitter:title" content="Rust: Closures and Threads"/>
<meta name="twitter:description" content="Closures Closures are a function that has access to variables in the same scope in which it is defined. Annotating types in closure definition are not required, types can be inferred by the compiler.
Closures in Threads When using a closure, variables defined in the same scope as the closure, are accessible inside the closure. But the same accessibility changes when closure runs in threads. Let&rsquo;s look at the examples below."/>

</head><body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
      <div class="title">
        <img src="https://wilspi.com/images/dp.jpg" alt="profile picture">
        <h3 title=""><a href="/">नमस्ते</a></h3>
        <div class="description">
          <p></p>
        </div>
      </div>
    </div>
    <ul class="social-links">
        
        <li>
        <a href="https://github.com/wilspi/" rel="me" aria-label="GitHub">
          <i class="fa fa-2x fa-github" aria-hidden="true"></i>
        </a>          
        </li>

        
        <li>
        <a href="https://www.youtube.com/channel/UCMg3idz-2FlreEeHY_0i13w" rel="me" aria-label="Youtube">
          <i class="fa fa-2x fa-youtube" aria-hidden="true"></i>
        </a>          
        </li>

        
        <li>
        <a href="https://www.twitter.com/iamwilspi" rel="me" aria-label="Twitter">
          <i class="fa fa-2x fa-twitter" aria-hidden="true"></i>
        </a>          
        </li>

        
        <li>
        <a href="https://www.instagram.com/wilspi/" rel="me" aria-label="Instagram">
          <i class="fa fa-2x fa-instagram" aria-hidden="true"></i>
        </a>          
        </li>

        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; wilspi 2020 </div>
      </div>
    </div>
</div><div class="main">
            <div class="page-top animated fadeInDown">
    <ul class="nav">
        
        
        
        <li><a  href="/" title="">Home</a></li>
        
        
        <li><a  href="https://notes.wilspi.com" title="">Notes</a></li>
        
    </ul>
    <div class="themeswitcher">
        <a class="theme-switch" title="Switch Theme">
            <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
        </a>
    </div>
</div>

            <div class="autopagerize_page_element">
                <div class="content">
<div class="post animated fadeInDown">
    <div class="post-content">

      <div class="post-title">
        <h1>Rust: Closures and Threads
        </h1>
        
        <div class="info">
          
          <i class="fa fa-clock-o"></i><span class="reading-time">2-minute read</span>
        </div>
        
        </div>

    <h2 id="closures">Closures</h2>
<p>Closures are a function that has access to variables in the same scope in which it is defined. Annotating types in closure definition are not required, types can be inferred by the compiler.</p>
<h2 id="closures-in-threads">Closures in Threads</h2>
<p>When using a closure, variables defined in the same scope as the closure, are accessible inside the closure. But the same accessibility changes when closure runs in threads.
Let&rsquo;s look at the examples below.</p>
<p>Here:</p>
<pre><code>let mut str = &quot;Hello&quot;.to_string();
let t = thread::spawn(|| {
    thread::sleep(time::Duration::from_secs(1));
    let mut str = format!(&quot;{:?}!&quot;, str);
    println!(&quot;str: {:?}&quot;, str);
});
t.join().unwrap();
</code></pre><p>We get the error: <code>closure may outlive the current function</code> because the main thread might drop <code>str</code> and the closure will not be able to access that variable.</p>
<p>To solve this we can use <a href="https://doc.rust-lang.org/std/keyword.move.html"><code>move</code></a> which will move the ownership, see below:</p>
<pre><code>let mut str = &quot;Hello&quot;.to_string();
let t = thread::spawn(move || {
    thread::sleep(time::Duration::from_secs(1));
    let mut str = format!(&quot;{:?}!&quot;, str);
    println!(&quot;str: {:?}&quot;, str);
});
t.join().unwrap();
</code></pre><p>This will build and run fine since <code>move</code> has moved the ownership of <code>str</code> to the thread.</p>
<p>Now lets  try to print <code>str</code> in the end in the main thread:</p>
<pre><code>let mut str = &quot;Hello&quot;.to_string();
let t = thread::spawn(move || {
    thread::sleep(time::Duration::from_secs(1));
    let mut str = format!(&quot;{:?}!&quot;, str);
    println!(&quot;str: {:?}&quot;, str);
});
t.join().unwrap();
println!(&quot;str: {:?}&quot;, str);
</code></pre><p>Here, the main thread is trying to access the variable which was moved to the thread, so the compiler gives an error here: <code>does not implement the 'Copy' trait</code>.</p>
<hr>
<p>Lets look at another example:</p>
<pre><code>let mut num = 20;
let t = thread::spawn(move || {
    thread::sleep(time::Duration::from_secs(1));
    let mut num = num + 1;
    println!(&quot;num: {:?}&quot;, num);
});
t.join().unwrap();
println!(&quot;num: {:?}&quot;, num);
</code></pre><p>Here, we get the output as:</p>
<pre><code>num: 21
num: 20
</code></pre><p>This works because <code>i32</code> implements copy trait and hence variable in the thread gets copied.</p>
<hr>
<p>So while using a closure in threads, we need to take care that:</p>
<ul>
<li><code>move</code> will move the ownership of the variable to the thread.</li>
<li>variables that need to be accessed inside closure and in the main thread, must implement <code>Copy</code> trait so that <code>move</code> will copy the variables.</li>
</ul>

    </div>
    <div class="post-footer">
      <div class="info">
        
<span class="separator"><a class="category" href="/categories/tech/">tech</a></span>

        
    <span class="separator"><a class="tag" href="/tags/rust/">rust</a><a class="tag" href="/tags/closures/">closures</a><a class="tag" href="/tags/thread/">thread</a></span>

      </div>
    </div>

    
    
    
</div>


                </div>
            </div>
        </div>
</body>



<script type="text/javascript" src="https://wilspi.com/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js" integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw=" crossorigin="anonymous"></script>




<script type="text/javascript" src="https://wilspi.com/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js" integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4=" crossorigin="anonymous"></script>

<script type="text/javascript" src="https://wilspi.com/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js" integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro=" crossorigin="anonymous"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-51915090-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
</html></body>

</html>
